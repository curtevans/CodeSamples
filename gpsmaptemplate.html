// A complex template to track trucks via GPS in real time and
// display with pickup location data

<!DOCTYPE html>
<html>

<head>
<meta content="initial-scale=1.0, user-scalable=no" name="viewport" />
<script src="/jscoord-1.1.1.js" type="text/javascript"></script>
<script src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=true" type="text/javascript"></script>
<script>
 //Ajax LTL module - Copyright 2010 Net2Business,llc. All rights reserved.


var gpsreq;
var gpsurl='http://home.kcdonationpickup.org/cgi/getgps.pl?trucks=1,2,3,4';
var vehicles=Array();
var xmap=Array();
var xmapctr=0;
var kmtofeet=3280.8399;
var tracks=Array();
var ispaused=Array();

function doedit(request)
{
window.open('http://'+document.domain+'/cgi/editrequest.pl?CMD=BLANK&idx='+request,'','width=950,height=1000,menubar=yes,scrollbars=1,resizable=1');
}

function report(truck)
{
window.open('http://'+document.domain+'/cgi/gpsreport.pl?truck='+truck,'','width=950,height=1000,menubar=yes,scrollbars=1,resizable=1');
}


function getgpsajax() 
{
        gpsreq= false;
        if(window.XMLHttpRequest) 
        {
            try {gpsreq= new XMLHttpRequest();} 
            catch(e)
             {gpsreq= false;}
        } else if(window.ActiveXObject) 
          {
            try {gpsreq= new ActiveXObject("Msxml2.XMLHTTP");}
            catch(e) {
                try {
                    gpsreq= new ActiveXObject("Microsoft.XMLHTTP");
                } catch(e) {
                    gpsreq= false;
                }
            }
        }
        
        if(gpsreq) 
        {
            gpsreq.onreadystatechange = gotgps;
            gpsreq.open("GET", gpsurl+'&r='+Math.random(), 'true');
            gpsreq.send("");
        }
}

function getgpsrelay(truck) 
{
        gpsreplay= false;
        if(window.XMLHttpRequest) 
        {
            try {gpsreplay= new XMLHttpRequest();} 
            catch(e)
             {gpsreplay= false;}
        } else if(window.ActiveXObject) 
          {
            try {gpsreplay= new ActiveXObject("Msxml2.XMLHTTP");}
            catch(e) {
                try {
                    gpsreplay= new ActiveXObject("Microsoft.XMLHTTP");
                } catch(e) {
                    gpsreplay= false;
                }
            }
        }
        
        if(gpsreplay) 
        {
            gpsreplay.onreadystatechange = gotgpsreplay;
            gpsreplay.open("GET", 'http://home.kcdonationpickup.org/cgi/getgpsreplay.pl?truck='+truck+'&r='+Math.random(), 'true');
            gpsreplay.send("");
        }
}



function gotgpsreplay() 
{
        var i;

        var buf;
        var a=new Array();
        var b=new Array();
        var thistruck;
        var t=new Array();


        if (gpsreplay.readyState == 4) 
		{
            // only if "OK"
            if (gpsreplay.status == 200) 
			{
  		     a=gpsreplay.responseText.split(/\n/);
			 for (i=0;i<a.length-1;i++)
			 {
              	b=a[i].split(/\t/);
			  
               	t[i]=new Object();  
				t[i].lat=b[0];
				t[i].lon=b[1];
				t[i].speed=b[2];
				t[i].epoch=b[3];
                t[i].time=fixtimestamp(parseInt(b[3]) * 1000);

                if (b[4])
                 {thistruck=b[4];}
      		 }

             tracks[thistruck]=t;
            document.getElementById('diversion'+thistruck).innerHTML=
                    '<input type="range" name="range'+thistruck+'" min="'+t[0].epoch+'" max="'+t[i-1].epoch+'" onchange="setrange('+thistruck+',this.value)"/>'
                    +'&nbsp;<a href="javascript:void(toggleplayback('+thistruck+'))"><img src="/images/play.gif"></a>'
                     ;	
		 }
        }
  
}

function toggleplayback(truck)
{

}


function fixtimestamp(stamp)
{
 var d;
 var h;
 var ampm;
 d=new Date(stamp);
 h =d.getHours();  
ampm=' am';
 if (h > 12)
 {
  h -= 12;
  ampm=' pm';
 }

  return (h+':'+datepad(d.getMinutes())+':'+datepad(d.getSeconds())+ampm);
}

function datepad(s)
{
 if (parseInt(s) < 10)
 {return '0'+s}
 else
 {return s}
}

function setrange(truck,v)
{
 var i;
 for (i=0;i<tracks[truck].length-1;i++)
 {
   if (v >= tracks[truck][i].epoch && v < tracks[truck][i+1].epoch)
   {
    centermap(truck,tracks[truck][i].lat,tracks[truck][i].lon);
    document.getElementById('index'+truck).innerHTML=tracks[truck][i].time;
   }
 }
}

function advancerange(truck)
{
 
    if ( truckptr[truck] < tracks[truck].length )
    {
     truckptr[truck]++;
     centermap(truck,tracks[truck][truckptr[truck]].lat,tracks[truck][truckptr[truck]].lon);
     document.getElementById('index'+truck).innerHTML=tracks[truck][truckptr[truck]].time;
    }

}


function pause(truck)
{
 if (ispaused[truck])
 {
  ispaused[truck]=false;
  document.getElementById('pause'+truck).src='/images/pause.gif';
 }
 else
 {
  getgpsrelay(truck);
  ispaused[truck]=true;
  document.getElementById('pause'+truck).src='/images/pausegray.gif';
 }
}

function gpshdop(r)
{
 if (r < 1)
 {return 'Ideal';}
 if (r >= 1 && r < 2)
 {return 'Excellent';}
 if (r >= 2 && r < 5)
 {return 'Good';}
 if (r >= 5 && r < 10)
 {return 'Moderate';}
 if (r >= 10 && r < 20)
 {return 'Fair';}
 if (r > 20)
 {return 'Poor';}
}

function gotgps() 
{
        var i;

        var buf;
		var stamp;

        var pickup='';
		
        // only if req shows "loaded"
        if (gpsreq.readyState == 4) 
		{
            // only if "OK"
            if (gpsreq.status == 200) 
			{
  		      var xml=gpsreq.responseXML.documentElement;
			  count=xml.getElementsByTagName("count")[0].childNodes[0].nodeValue  ;
			  for (i=0;i<count;i++)
              {
                vehicles[i]=new Object();
                x=xml.getElementsByTagName("vehicle")[i].childNodes;
                for (j=0;j<x.length;j++)
                {
                 vehicles[i][x[j].nodeName]=x[j].childNodes[0].nodeValue;
                }     
               p=document.getElementById('legend'+vehicles[i].number);  
               stamp=   vehicles[i].stamp
               buf='<table style="width:100%"><tr style="height:10px;"><td><b>Speed: </b>'+vehicles[i].speed+' [max. '+vehicles[i].maxspeed+'] '
      					   +'<b>Last Update: </b>'+fixstamp(vehicles[i].stamp)+'</td><td></td><td></td></tr>';
               pickup=findaddress(vehicles[i].number,vehicles[i].lat,vehicles[i].lon);

               if (pickup.length < 1)
               {pickup=vehicles[i].address;}
               
               			

               buf +='<tr style="height:10px;"><td>'+ pickup+'</td><td></td><td></td></tr>';
			   buf +='<tr style="height:10px;"><td id="diversion'+vehicles[i].number+'">';
              
               buf += '<a href="javascript:void(getdistance('+vehicles[i].lat+','+vehicles[i].lon+'))">Check Diversion</a></td>';
               buf +='<td id="index'+vehicles[i].number+'" style="text-align:right"></td><td></td><tr></table>'
               if (!ispaused[vehicles[i].number])
               {p.innerHTML=buf;}
               p=document.getElementById('status'+vehicles[i].number);
               if (document.getElementById('status'+vehicles[i].number))
               {
                buf='';
                buf += '<a href="javascript:void(pause('+vehicles[i].number+'))" title="Click to Pause Tracking"><img id="pause'+vehicles[i].number+'" src="/images/pause.gif" border="0" ></a> ';
                buf += '<a href="javascript:void(report('+vehicles[i].number+'))" title="Click for route report"><img  src="/images/report.gif" border="0"></a> ';
                if (vehicles[i].gpsstatus==1)
                {buf +='<img title="GPS Locked" style="height:15px" src="/images/gpslock.gif"> '}
                else
                {buf +='<img  title="No GPS Lock" style="height:15px" src="/images/gpsunlock.gif" > '};
                buf += '<img title="Signal '+vehicles[i].signal+'" style="height:15px" src="'+signalicon(vehicles[i].signal)+'"> ';
                buf += ignition(vehicles[i].ignitionmode);
               if (!ispaused[vehicles[i].number])
                {p.innerHTML=buf;}
               }
               if (!ispaused[vehicles[i].number])
			   {  centermap(vehicles[i].number,vehicles[i].lat,vehicles[i].lon);}
              }
			 }
        }

}

function signalicon(s)
{
 var signal=parseInt(s);
 if (signal < 1)
 {
  return '/images/bar0.gif';
 }
 if (signal >= 1 && signal < 8)
 {
  return '/images/bar1.gif';
 }
 if (signal >= 8 && signal < 16)
 {
  return '/images/bar2.gif';
 }

 if (signal >= 16 &&signal < 24)
 {
  return '/images/bar3.gif';
 }
 if (signal >= 24 )
 {
  return '/images/bar4.gif';
 }


}

function ignition(b)
{
 if (b==1)
 {return '<img title="Ignition On" style="height:15px" src="/images/ignon.gif">';}
 else
 {return '<img title="Ignition Off" style="height:15px" src="/images/ignoff.gif">';}

}


function fixstamp(s)
{
 var a=new Array();
 s=s.substr(0,s.length-3);
 a=s.split(' ');

 return (fixdate(a[0])+' '+fixtime(a[1]));
}

function fixtime(s)
{
  var a=new Array();
  var m;

  a=s.split(':');
  if (a[0] > 12)
   {a[0]=a[0]-12;m=' pm';}
  else
   {m='am';}
  return (a[0]+':'+a[1]+':'+a[2]+m);
}

function fixdate(s)
{
 var a=new Array();
 a=s.split('-');
 return '';// (a[1]+'/'+a[2]+'/'+a[0]);
}

</script>
<script type="text/javascript">
  var geocoder;
  var map;
  var mapctr=0;
  var xref=new Array();

  var latlng;
  var myOptions;
  var inrect=false;
  var upperleft;
  var rect=new google.maps.Rectangle({});
  var rlistener;
  var bounds=new google.maps.LatLngBounds();
  var temp = new google.maps.LatLng;
  var qmaps=new Array();
  var bullseye=new Array();

 function centermap(truck,lat,lon)
 {

   var latlng = new google.maps.LatLng(lat, lon);
   var i;
   var map;
    var index;
   
   for (i=0;i<xref.length;i++)
    {
     if  (xref[i]==truck)
     {
      map=qmaps[i];
      map.panTo(latlng);
      index=i;
     }
    }
    if (bullseye[index])
    {
     bullseye[index].setMap(null);
    }
     var marker = new google.maps.Marker({
                map: map, 
                position: latlng,
                icon:'/images/bullseye.gif'
            });
    bullseye[index]=marker; 
    
 } 

 function findaddress(truck,lat,lon)
 {
  var i;
var a=Array();

  var point=new LatLng(lat,lon);

  for (i=0;i<xmapctr;i++)
  {

    if (Math.abs(xmap[i].latlng.distance(point)*kmtofeet) < 150)
    {
     a=xmap[i].title.split(/,/);
     return '<a href="javascript:void(doedit('+xmap[i].request+'))">'+a[0]+', '+a[1]+'</a>';
    }
  }
  return '';
 }

  function putmap(mapno,lat,long,titletext,num,truck,request) 
  {
    var latlng = new google.maps.LatLng(lat, long);
    var i;
    var map;

    xmap[xmapctr]=new Object();
    xmap[xmapctr].latlng=new LatLng(lat,long);
    xmap[xmapctr].truck=truck;
    xmap[xmapctr].title=titletext.replace(/#.*$/,'');
    xmap[xmapctr].request=request;
    xmapctr++;
    
    for (i=0;i<xref.length;i++)
    {
     if  (xref[i]==mapno)
     {
      map=qmaps[i];
     }
    }

            var marker = new google.maps.Marker({
                map: map, 
                position: latlng,
                title:titletext,
                clickable:true,
                icon:'/cgi/mapicon.pl?icon=^icontype&n='+num+'&truck='+truck
            });
      
    google.maps.event.addListener(marker, 'click', function() {
    															map.setCenter(latlng);
    															map.setZoom(16);
    															var infowindow = new google.maps.InfoWindow({content: titletext});
    															infowindow.open(map,marker);
    
    															}
    							 );
  }

  function setmap()
  {
   var i;
   var p;
   var s;


   for (i=1;i<=6;i++)
   {
    if (document.getElementById('truckselect'+i))
    {
     p=document.getElementById('truckselect'+i);
     xmap[i]=p.options[p.selectedIndex].value;
    }
    else
    {
      xmap[i]=0; 
    }
   }
  }


  function newmap(mapno,x,y)
  {
    var latlng = new google.maps.LatLng(x, y);
    var p;
    var opts = 
    {
      zoom: 16,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }

   qmaps[mapctr]=new google.maps.Map(document.getElementById('map'+mapno), opts);
   p=document.getElementById('map'+mapno);
   p.style.borderColor='navy';
   p.style.borderWidth='2px';
   p.style.borderStyle='solid';
   p=document.getElementById('t'+mapno);
   p.innerHTML='<table width="100%"><tr><td>Route '+mapno+'</td><td id="status'+mapno+'" align="right"></td></tr></table>'

   xref[mapctr]=mapno;
   mapctr++;

}

function getdistance(lat,lon)
{
 window.open('/getzip.html?lat='+lat+'&lng='+lon,'','width=900,height=700');
}
  
function init() 
  {
 
    ^addresslist  
     setInterval('getgpsajax()',10000);
    getgpsajax();
    								                     
  }
  
</script>
<style>
.mapclass {
	float: left;
	width: 400px;
	height: 400px;
	margin: 5px 5px 0px 0px;
	padding: 2px 2px 2px 2px;
}
.panelclass {
	float: left;
	height: 535px;
	border: 2px black solid;
	margin: 0px 5px 5px 0px;
}
</style>
</head>

<body onload="init()">

<div>
	<table>
		<tr>
			<td id="x"></td>
		</tr>
	</table>
</div>
<div style="overflow: auto; width: 100%">
	<div class="panelclass">
		<table>
			<tr>
				<td id="t1"></td>
			</tr>
			<tr>
				<td>
				<div id="map1" class="mapclass">
				</div>
				</td>
			</tr>
			<tr style="height: 70px">
				<td id="legend1"></td>
			</tr>
		</table>
	</div>
	<div class="panelclass">
		<table>
			<tr>
				<td id="t2"></td>
			</tr>
			<tr>
				<td>
				<div id="map2" class="mapclass">
				</div>
				</td>
			</tr>
			<tr style="height: 70px">
				<td id="legend2"></td>
			</tr>
		</table>
	</div>
	<div class="panelclass">
		<table>
			<tr>
				<td id="t3"></td>
			</tr>
			<tr>
				<td>
				<div id="map3" class="mapclass">
				</div>
				</td>
			</tr>
			<tr style="height: 70px">
				<td id="legend3"></td>
			</tr>
		</table>
	</div>
	<div class="panelclass">
		<table>
			<tr>
				<td id="t4"></td>
			</tr>
			<tr>
				<td>
				<div id="map4" class="mapclass">
				</div>
				</td>
			</tr>
			<tr>
				<td id="legend4"></td>
			</tr>
		</table>
	</div>
	<div class="panelclass">
		<table>
			<tr>
				<td id="t5"></td>
			</tr>
			<tr>
				<td>
				<div id="map5" class="mapclass">
				</div>
				</td>
			</tr>
			<tr>
				<td id="legend5"></td>
			</tr>
		</table>
	</div>
	<div class="panelclass">
		<table>
			<tr>
				<td id="t6"></td>
			</tr>
			<tr>
				<td>
				<div id="map6" class="mapclass">
				</div>
				</td>
			</tr>
			<tr>
				<td id="legend6"></td>
			</tr>
		</table>
	</div>
</div>

</body>

</html>
